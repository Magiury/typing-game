<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Morse Duel</title>

<style>
body {
  margin: 0;
  background: #0e0e0e;
  color: #e5e5e5;
  font-family: monospace;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
#app { width: 700px; }
h1 { text-align: center; letter-spacing: 4px; }
#status { text-align: center; opacity: .6; margin: 10px; }
#score { text-align: center; margin-bottom: 10px; }
#game { border-top: 1px solid #333; padding-top: 20px; }
input {
  width: 100%;
  background: transparent;
  border: none;
  border-bottom: 1px solid #555;
  color: #fff;
  font-size: 20px;
  outline: none;
}
.morse { font-size: 32px; text-align: center; margin: 20px; }
.timer { text-align: center; font-size: 18px; }
.correct { color: #4caf50; }
.wrong { color: #f44336; }
</style>
</head>

<body>
<div id="app">
  <h1>M O R S E &nbsp; D U E L</h1>
  <div id="status">Connecting...</div>
  <div id="score">You 0 — 0 Opponent</div>

  <div id="game"></div>
</div>

<script>
const ws = new WebSocket("ws://localhost:8080");

let playerIndex = 0;
let isSender = false;
let timer;
let answer = "";

const gameDiv = document.getElementById("game");
const statusDiv = document.getElementById("status");
const scoreDiv = document.getElementById("score");

ws.onopen = () => ws.send(JSON.stringify({ type: "join" }));

ws.onmessage = e => {
  const data = JSON.parse(e.data);

  if (data.type === "waiting") {
    statusDiv.textContent = "Waiting for online player...";
  }

  if (data.type === "start") {
    playerIndex = data.you;
    updateScores(data.scores);
    setRole(data.sender);
  }

  if (data.type === "playMorse") {
    playMorse(data.morse);
    showDecode();
  }

  if (data.type === "roundEnd") {
    updateScores(data.scores);
    setRole(data.sender);
  }

  if (data.type === "gameOver") {
    statusDiv.textContent = "GAME OVER";
  }

  if (data.type === "opponentLeft") {
    statusDiv.textContent = "Opponent disconnected — Victory";
  }
};

function setRole(sender) {
  isSender = sender === playerIndex;
  gameDiv.innerHTML = "";
  statusDiv.textContent = isSender ? "Your turn to send" : "Your turn to decode";

  isSender ? showSend() : null;
}

function showSend() {
  const input = document.createElement("input");
  input.placeholder = "Enter MORSE using SPACE";
  let spaces = "";

  input.onkeydown = e => {
    if (e.code === "Space") {
      spaces += " ";
      e.preventDefault();
    }
    if (e.code === "Enter") {
      const morse = spaces.trim();
      ws.send(JSON.stringify({
        type: "morse",
        morse,
        text: "HELLO" // demo fixed answer
      }));
      spaces = "";
      input.value = "";
    }
  };

  gameDiv.appendChild(input);
}

function showDecode() {
  gameDiv.innerHTML = `
    <div class="morse">• — • •</div>
    <div class="timer" id="timer"></div>
    <input id="guess" placeholder="Type decoded text" />
  `;

  let time = 15;
  document.getElementById("timer").textContent = time;

  timer = setInterval(() => {
    time--;
    document.getElementById("timer").textContent = time;
    if (time <= 0) submitGuess("");
  }, 1000);

  document.getElementById("guess").onkeydown = e => {
    if (e.key === "Enter") submitGuess(e.target.value.toUpperCase());
  };
}

function submitGuess(text) {
  clearInterval(timer);
  ws.send(JSON.stringify({
    type: "guess",
    text,
    player: playerIndex
  }));
}

function updateScores(scores) {
  scoreDiv.textContent = `You ${scores[playerIndex]} — ${scores[1-playerIndex]} Opponent`;
}

function playMorse(morse) {
  // audio placeholder
}
</script>
</body>
</html>
